{% extends "ai_playground/base.html" %}
{% load i18n static %}

{% block title %}{% trans "AI Playground" %}{% endblock %}

{% block topbar_subtitle %}
<p class="ai-playground-topbar-subtitle muted">{% trans "Take a selfie, choose a style, and run a simulated haircut preview." %}</p>
{% endblock %}

{% block topbar_right %}
<span class="badge">
    {% trans "Session expires at" %} {{ active_session.expires_at|date:"Y-m-d H:i" }}
</span>
{% endblock %}

{% block content %}
<section
    id="ai-playground-root"
    data-selfie-upload-url="{% url 'ai-playground-selfie-upload' %}"
    data-generate-url="{% url 'ai-playground-generate' %}"
    data-generate-expert-url="{% url 'ai-playground-generate-expert' %}"
    data-styles-url="{% url 'ai-playground-styles' %}"
    data-has-selfie="{% if active_session.has_selfie %}true{% else %}false{% endif %}"
    data-selfie-url="{% if active_session.selfie_image %}{{ active_session.selfie_image.url }}{% endif %}"
    data-msg-camera-opened="{% trans 'Camera is ready. Capture your selfie.' %}"
    data-msg-camera-denied="{% trans 'Camera access failed. Use file upload instead.' %}"
    data-msg-camera-busy="{% trans 'Camera is in use by another app or tab. Close other camera apps and retry.' %}"
    data-msg-camera-not-found="{% trans 'No camera device was found on this device.' %}"
    data-msg-camera-secure-context="{% trans 'Camera requires HTTPS (or localhost). Open the page over a secure connection.' %}"
    data-msg-selfie-required="{% trans 'Upload a selfie before trying styles.' %}"
    data-msg-selfie-saved="{% trans 'Selfie saved.' %}"
    data-msg-selfie-save-failed="{% trans 'Could not save selfie. Please retry.' %}"
    data-msg-selfie-uploading="{% trans 'Saving selfie...' %}"
    data-msg-selfie-captured="{% trans 'Selfie captured. Saving...' %}"
    data-msg-selfie-selected="{% trans 'Selfie selected. Saving...' %}"
    data-msg-selfie-retake-ready="{% trans 'Retake ready. Capture or upload a new selfie.' %}"
    data-msg-hair-style-required="{% trans 'Choose a hairstyle first.' %}"
    data-msg-hair-color-required="{% trans 'Choose a hair color option first.' %}"
    data-msg-beard-style-required="{% trans 'Choose a beard style option first.' %}"
    data-msg-beard-color-required="{% trans 'Choose a beard color option first.' %}"
    data-msg-beard-color-needs-style="{% trans 'Choose a beard style before applying beard color.' %}"
    data-msg-generate-failed="{% trans 'Generation request failed.' %}"
    data-msg-generate-started="{% trans 'Request sent. Preparing AI transformation...' %}"
    data-msg-generate-complete="{% trans 'Preview is ready.' %}"
    data-msg-generate-cta-ready="{% trans 'Generate' %}"
    data-msg-generate-cta-prompt="{% trans 'Choose a Hair/Beard style to generate' %}"
    data-msg-expert-generate-started="{% trans 'Request sent. Building expert haircut recommendation...' %}"
    data-msg-expert-modal-required="{% trans 'Select expert options first.' %}"
>
    <div class="ai-main-layout">
        <aside id="style-step" class="card ai-playground-card ai-main-side-panel">
            <div class="ai-side-panel-header">
                <h2>{% trans "Look Builder" %}</h2>
                <p class="muted">{% trans "Use the left sidebar to expand Hairstyles and Beards." %}</p>
            </div>
            <div class="ai-look-builder" data-active-builder="hair">
                <div class="ai-look-nav">
                    <button
                        type="button"
                        class="ai-look-nav-item js-builder-tab is-active"
                        data-builder-tab="hair"
                        aria-pressed="true"
                        aria-expanded="true"
                        aria-controls="hair-builder-panel"
                    >
                        <span class="ai-look-nav-label">{% trans "Hairstyles" %}</span>
                    </button>
                    <button
                        type="button"
                        class="ai-look-nav-item js-builder-tab"
                        data-builder-tab="beard"
                        aria-pressed="false"
                        aria-expanded="false"
                        aria-controls="beard-builder-panel"
                    >
                        <span class="ai-look-nav-label">{% trans "Beards" %}</span>
                    </button>
                </div>
                <div class="ai-look-workspace">
                    <section id="hair-builder-panel" class="ai-look-panel" role="region" aria-label="{% trans 'Hairstyles panel' %}">
                        <header class="ai-look-panel-header">
                            <h3>{% trans "Hairstyles" %}</h3>
                        </header>
                        <div class="ai-look-panel-grid">
                            <div class="ai-look-style-column">
                                <div id="hair-style-slider" class="ai-style-grid-scroll" role="listbox" aria-label="{% trans 'Hairstyle options' %}">
                                    <button
                                        type="button"
                                        class="ai-style-option ai-style-option-empty ai-style-option-none-choice js-hair-style-option"
                                        data-style-id="none"
                                        data-style-name="{% trans 'No hairstyle change' %}"
                                        data-style-image-url=""
                                        aria-label="{% trans 'No hairstyle change' %}"
                                        aria-pressed="false"
                                    >
                                        <span class="ai-style-option-none-sign" aria-hidden="true"></span>
                                    </button>
                                    {% for style in styles %}
                                        <button
                                            type="button"
                                            class="ai-style-option js-hair-style-option"
                                            data-style-id="{{ style.id }}"
                                            data-style-name="{% if style.name %}{{ style.name }}{% endif %}"
                                            data-style-image-url="{{ style.image.url }}"
                                            aria-pressed="false"
                                        >
                                            <span class="ai-style-option-media">
                                                <img
                                                    src="{{ style.image.url }}"
                                                    alt="{% if style.name %}{{ style.name }}{% else %}{% trans 'Haircut style reference' %}{% endif %}"
                                                >
                                            </span>
                                            {% if style.name %}
                                                <span class="ai-style-option-label">{{ style.name }}</span>
                                            {% endif %}
                                        </button>
                                    {% empty %}
                                        <p class="muted ai-style-empty-state">{% trans "No active hairstyles yet." %}</p>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="ai-look-color-column">
                                <div id="hair-color-palette" class="ai-color-list-scroll" role="listbox" aria-label="{% trans 'Hair color options' %}">
                                    <button
                                        type="button"
                                        class="ai-color-chip ai-color-chip-none js-hair-color-option"
                                        data-color-id="none"
                                        data-color-name="{% trans 'Default' %}"
                                        aria-pressed="false"
                                    >
                                        <span class="ai-color-dot ai-color-dot-none"></span>
                                        <span>{% trans "Default" %}</span>
                                    </button>
                                    {% for color in hair_colors %}
                                        <button
                                            type="button"
                                            class="ai-color-chip js-hair-color-option"
                                            data-color-id="{{ color.id }}"
                                            data-color-name="{{ color.name }}"
                                            aria-pressed="false"
                                        >
                                            <span class="ai-color-dot" style="background: {{ color.hex_code }};"></span>
                                            <span>{{ color.name }}</span>
                                        </button>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </section>

                    <section id="beard-builder-panel" class="ai-look-panel hidden" role="region" aria-label="{% trans 'Beards panel' %}">
                        <header class="ai-look-panel-header">
                            <h3>{% trans "Beards" %}</h3>
                        </header>
                        <div class="ai-look-panel-grid">
                            <div class="ai-look-style-column">
                                <div id="beard-style-slider" class="ai-style-grid-scroll" role="listbox" aria-label="{% trans 'Beard style options' %}">
                                    <button
                                        type="button"
                                        class="ai-style-option ai-style-option-empty ai-style-option-none-choice js-beard-style-option"
                                        data-beard-style-id="none"
                                        data-beard-style-name="{% trans 'No beard change' %}"
                                        data-style-image-url=""
                                        aria-label="{% trans 'No beard change' %}"
                                        aria-pressed="false"
                                    >
                                        <span class="ai-style-option-none-sign" aria-hidden="true"></span>
                                    </button>
                                    {% for style in beard_styles %}
                                        <button
                                            type="button"
                                            class="ai-style-option js-beard-style-option"
                                            data-beard-style-id="{{ style.id }}"
                                            data-beard-style-name="{% if style.name %}{{ style.name }}{% endif %}"
                                            data-style-image-url="{{ style.image.url }}"
                                            aria-pressed="false"
                                        >
                                            <span class="ai-style-option-media">
                                                <img
                                                    src="{{ style.image.url }}"
                                                    alt="{% if style.name %}{{ style.name }}{% else %}{% trans 'Beard style reference' %}{% endif %}"
                                                >
                                            </span>
                                            {% if style.name %}
                                                <span class="ai-style-option-label">{{ style.name }}</span>
                                            {% endif %}
                                        </button>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="ai-look-color-column">
                                <div id="beard-color-palette" class="ai-color-list-scroll" role="listbox" aria-label="{% trans 'Beard color options' %}">
                                    <button
                                        type="button"
                                        class="ai-color-chip ai-color-chip-none js-beard-color-option"
                                        data-color-id="none"
                                        data-color-name="{% trans 'Default' %}"
                                        aria-pressed="false"
                                    >
                                        <span class="ai-color-dot ai-color-dot-none"></span>
                                        <span>{% trans "Default" %}</span>
                                    </button>
                                    {% for color in beard_colors %}
                                        <button
                                            type="button"
                                            class="ai-color-chip js-beard-color-option"
                                            data-color-id="{{ color.id }}"
                                            data-color-name="{{ color.name }}"
                                            aria-pressed="false"
                                        >
                                            <span class="ai-color-dot" style="background: {{ color.hex_code }};"></span>
                                            <span>{{ color.name }}</span>
                                        </button>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </section>

                    <p id="style-selection-status" class="muted ai-selection-status">
                        {% trans "Choose a hairstyle or beard style, then generate." %}
                    </p>
                </div>
            </div>
        </aside>

        <div class="ai-main-content">
            <section id="selfie-step" class="card ai-playground-card">
                <h2>{% trans "Take or Upload a Selfie" %}</h2>
                <div id="selfie-input-grid" class="ai-selfie-grid{% if active_session.has_selfie %} hidden{% endif %}">
                    <div class="ai-selfie-pane ai-selfie-pane-media">
                        <button id="camera-selfie-block" type="button" class="camera-selfie-block">
                            <span class="camera-selfie-icon" aria-hidden="true"></span>
                            <span class="camera-selfie-label">{% trans "Camera" %}</span>
                        </button>
                        <video id="selfie-video" class="camera-video hidden" autoplay playsinline muted></video>
                    </div>
                    <div class="ai-selfie-pane ai-selfie-pane-upload">
                        <label
                            id="selfie-upload-zone"
                            for="selfie-input"
                            class="upload-zone"
                            role="button"
                            tabindex="0"
                        >
                            <span class="upload-zone-cta">
                                <span class="upload-zone-mark" aria-hidden="true">+</span>
                                <span class="upload-zone-title">{% trans "Tap or drop selfie" %}</span>
                            </span>
                            <span id="selfie-upload-filename" class="upload-zone-file muted hidden"></span>
                        </label>
                        <input
                            id="selfie-input"
                            class="visually-hidden-file"
                            type="file"
                            accept="image/jpeg,image/png,image/webp"
                            capture="user"
                        >
                    </div>
                </div>
                <div id="selfie-preview-block" class="ai-selfie-preview-block{% if not active_session.has_selfie %} hidden{% endif %}">
                    <div id="selfie-compare-stage" class="ai-selfie-compare-stage{% if latest_generation %} is-split has-result{% endif %}">
                        <div class="ai-compare-pane ai-compare-pane-before">
                            <img
                                id="selfie-preview"
                                class="camera-preview{% if not active_session.selfie_image %} hidden{% endif %}"
                                {% if active_session.selfie_image %}src="{{ active_session.selfie_image.url }}"{% endif %}
                                alt="{% trans 'Saved selfie preview' %}"
                            >
                            <span class="ai-compare-tag">{% trans "Before" %}</span>
                        </div>
                        <div class="ai-compare-separator" aria-hidden="true"></div>
                        <div class="ai-compare-pane ai-compare-pane-after">
                            <img
                                id="generated-result-image"
                                class="camera-preview{% if not latest_generation %} hidden{% endif %}"
                                {% if latest_generation %}src="{{ latest_generation.result_image.url }}"{% endif %}
                                alt="{% trans 'Generated haircut preview' %}"
                            >
                            <div id="generate-loader" class="ai-generate-loader ai-compare-loader hidden">
                                <span class="ai-spinner" aria-hidden="true"></span>
                                <span>{% trans "Generating preview..." %}</span>
                            </div>
                            <span class="ai-compare-tag ai-compare-tag-after">{% trans "After" %}</span>
                        </div>
                    </div>
                    <div class="ai-selfie-preview-actions">
                        <button id="selfie-take-photo-btn" type="button" class="btn btn-sm">
                            {% trans "Take a photo" %}
                        </button>
                        <button id="selfie-replace-btn" type="button" class="btn btn-outline btn-sm">
                            {% trans "Use another selfie" %}
                        </button>
                        <button id="selfie-generate-btn" type="button" class="btn btn-sm">
                            {% trans "Choose a Hair/Beard style to generate" %}
                        </button>
                        <button id="selfie-expert-generate-btn" type="button" class="btn btn-outline btn-sm ai-expert-cta">
                            {% trans "Generate Expert Haircut" %}
                        </button>
                    </div>
                    <div id="expert-options-modal" class="ai-expert-modal hidden" role="dialog" aria-modal="true" aria-labelledby="expert-options-title">
                        <div class="ai-expert-modal-surface">
                            <h3 id="expert-options-title">{% trans "Expert Haircut Preferences" %}</h3>
                            <p class="muted">{% trans "Guide the AI stylist before generating your face-fit haircut." %}</p>
                            <form id="expert-options-form" class="ai-expert-form">
                                <label class="ai-expert-field" for="expert-style-vibe">
                                    <span>{% trans "Style vibe" %}</span>
                                    <select id="expert-style-vibe" name="style_vibe">
                                        <option value="classic">{% trans "Classic" %}</option>
                                        <option value="casual">{% trans "Casual" %}</option>
                                        <option value="modern">{% trans "Modern" %}</option>
                                        <option value="bold">{% trans "Bold" %}</option>
                                    </select>
                                </label>
                                <label class="ai-expert-field" for="expert-lifestyle">
                                    <span>{% trans "Lifestyle" %}</span>
                                    <select id="expert-lifestyle" name="lifestyle">
                                        <option value="balanced">{% trans "Balanced" %}</option>
                                        <option value="office">{% trans "Office" %}</option>
                                        <option value="active">{% trans "Active" %}</option>
                                        <option value="creative">{% trans "Creative" %}</option>
                                    </select>
                                </label>
                                <label class="ai-expert-field" for="expert-maintenance">
                                    <span>{% trans "Maintenance" %}</span>
                                    <select id="expert-maintenance" name="maintenance">
                                        <option value="medium">{% trans "Medium" %}</option>
                                        <option value="low">{% trans "Low" %}</option>
                                        <option value="high">{% trans "High" %}</option>
                                    </select>
                                </label>
                                <label class="ai-expert-field" for="expert-hair-length">
                                    <span>{% trans "Hair length" %}</span>
                                    <select id="expert-hair-length" name="hair_length">
                                        <option value="short">{% trans "Short" %}</option>
                                        <option value="medium">{% trans "Medium" %}</option>
                                        <option value="long">{% trans "Long" %}</option>
                                    </select>
                                </label>
                                <div class="ai-expert-actions">
                                    <button id="expert-options-cancel-btn" type="button" class="btn btn-outline btn-sm">
                                        {% trans "Cancel" %}
                                    </button>
                                    <button id="expert-options-submit-btn" type="submit" class="btn btn-sm">
                                        {% trans "Generate Expert Haircut" %}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <p id="selfie-status" class="muted hidden"></p>
                <div id="selfie-generation-block" class="ai-selfie-generation-block{% if not active_session.has_selfie %} hidden{% endif %}">
                    <p id="generate-status" class="muted"></p>
                </div>
            </section>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/ai-playground.js' %}"></script>
{% endblock %}
